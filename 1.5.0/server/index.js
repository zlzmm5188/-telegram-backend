import{jsx as e,jsxs as t,Fragment as a}from"react/jsx-runtime";import{PassThrough as r}from"node:stream";import{renderToPipeableStream as s}from"react-dom/server";import{createReadableStreamFromReadable as n,createCookie as o,json as i,redirect as d}from"@remix-run/node";import{RemixServer as c,Outlet as l,Meta as u,Links as m,ScrollRestoration as p,Scripts as h,useActionData as g,useNavigate as f,useSubmit as _,Link as v,redirect as w,useLoaderData as y,useFetcher as b,useSearchParams as S,NavLink as j,Form as x}from"@remix-run/react";import{isbot as N}from"isbot";import{ConfigProvider as C,theme as z,App as I,Form as k,Input as T,Button as E,Table as A,DatePicker as L,Popconfirm as O,Modal as M}from"antd";import P from"antd/locale/zh_CN.js";import D from"dayjs";import"dayjs/locale/zh-cn.js";import*as R from"react";import{useState as F,useEffect as $,memo as q}from"react";import B from"crypto";import{PrismaClient as U}from"@prisma/client";import V from"jsonwebtoken";const H=Object.freeze(Object.defineProperty({__proto__:null,default:async function(t,a,o,i){const d=N(t.headers.get("user-agent"))?"onAllReady":"onShellReady";return new Promise(((l,u)=>{let m=!1;const{pipe:p,abort:h}=s(e(c,{context:i,url:t.url}),{[d](){m=!0;const e=new r,t=n(e);o.set("Content-Type","text/html"),l(new Response(t,{headers:o,status:a})),p(e)},onShellError(e){u(e)},onError(e){a=500,m&&console.error(e)}});setTimeout(h,6e3)}))},streamTimeout:5e3},Symbol.toStringTag,{value:"Module"}));D.locale("zh-cn");const Y=Object.freeze(Object.defineProperty({__proto__:null,Layout:function({children:a}){return t("html",{lang:"en",children:[t("head",{children:[e("meta",{charSet:"utf-8"}),e("meta",{name:"viewport",content:"width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"}),e("meta",{name:"robots",content:"noindex, nofollow"}),e("meta",{name:"googlebot",content:"noindex, nofollow"}),e("meta",{name:"google",content:"notranslate"}),e(u,{}),e(m,{})]}),t("body",{children:[a,e(p,{}),e(h,{})]})]})},default:function(){const t=function(){const[e,t]=R.useState(!1);return R.useEffect((()=>{t(!0)}),[]),e}(),[a,r]=F("dark");return $((()=>{const e=window.matchMedia("(prefers-color-scheme: dark)");r(e.matches?"dark":"light");const t=e=>{r(e.matches?"dark":"light")};return e.addEventListener("change",t),()=>e.removeEventListener("change",t)}),[]),t?e(C,{locale:P,wave:{disabled:!0},theme:{algorithm:"dark"===a?z.darkAlgorithm:z.defaultAlgorithm},children:e(I,{children:e(l,{})})}):null},loader:async()=>({appName:process.env.APP_NAME}),meta:({data:e})=>[{title:e?e.appName:"Telegram"}]},Symbol.toStringTag,{value:"Module"}));let X;const G=()=>{const e=new U({log:"development"===process.env.NODE_ENV?["query","error","warn"]:["error"]});return e.$connect().catch((e=>{console.error("Failed to connect to database:",e),process.exit(1)})),e};"undefined"==typeof window&&("production"===process.env.NODE_ENV?X=G():(global.__prisma||(global.__prisma=G()),X=global.__prisma));const J=process.env.JWT_SECRET||"telegram-app",K=o("auth",{secure:"production"===process.env.NODE_ENV,httpOnly:!0,sameSite:"lax",path:"/",maxAge:2592e3});async function W(e){try{const t=e.headers.get("Cookie"),a=await K.parse(t)||void 0;if(!(null==a?void 0:a.token))return!1;return!!V.verify(a.token,J).username}catch{return!1}}async function Q(e){const t=e.headers.get("Cookie"),a=await K.parse(t)||void 0;return V.verify(a.token,J)}async function Z(){return await K.serialize({token:""},{expires:new Date(0),maxAge:0,path:"/"})}const ee=Object.freeze(Object.defineProperty({__proto__:null,action:async function({request:e}){const t=await e.formData(),a=t.get("username"),r=t.get("password"),s=t.get("newPassword");if(!a||!r||!s)return{success:!1,errors:"请输入用户名、旧密码和新密码"};return await async function(e,t,a){const r=await X.d_user.findFirst({where:{username:e}});if(!r)return!1;const s=B.createHash("md5").update(t).digest("hex");if(r.password!==s)return!1;const n=B.createHash("md5").update(a).digest("hex");return await X.d_user.update({where:{username:e},data:{password:n}}),!0}(a,r,s)?{success:!0}:{success:!1,errors:"旧密码错误"}},default:function(){const r=g(),s=f(),{message:n}=I.useApp(),[o]=k.useForm(),i=_(),[d,c]=F(!1);return $((()=>{r&&(c(!1),r.success?(n.success("重置成功"),s("/login")):n.error(r.errors))}),[r,n]),t(a,{children:[t(k,{form:o,name:"login",className:"space-y-4",onFinish:async e=>{c(!0),i(e,{method:"post"})},layout:"vertical",children:[e(k.Item,{name:"username",rules:[{required:!0,message:"请输入用户名"}],children:e(T,{name:"username",placeholder:"用户名",size:"large"})}),e(k.Item,{name:"password",rules:[{required:!0,message:"请输入旧密码"}],children:e(T.Password,{name:"password",placeholder:"旧密码",size:"large"})}),e(k.Item,{name:"newPassword",rules:[{required:!0,message:"请输入新密码"}],children:e(T.Password,{name:"newPassword",placeholder:"新密码",size:"large"})}),e(k.Item,{children:e(E,{type:"primary",htmlType:"submit",loading:d,block:!0,size:"large",children:d?"重置中...":"重置"})})]}),e(v,{to:"/login",className:"mt-4 block text-sm",children:"返回登录"})]})},loader:async function({request:e}){return await W(e)?w("/dashboard"):null},shouldRevalidate:function(){return!1}},Symbol.toStringTag,{value:"Module"}));const te=["20","40","60","80","100"],ae={x:1e3,y:"calc(100vh - 280px)"},re=e=>D(1e3*e).format("YYYY-MM-DD HH:mm:ss"),se=({created_at:e,updated_at:a})=>t("div",{children:[t("div",{children:["创建时间: ",re(e)]}),t("div",{children:["更新时间: ",re(a)]})]}),ne=({url:e,invite_code:a})=>t("div",{children:[t("div",{children:["链接: ",e]}),t("div",{children:["邀请码: ","null"===a?"无":a]})]}),oe=({record:a})=>{const{loginUrl:r}=y(),s=b(),{message:n,modal:o}=I.useApp(),i=({defaultValue:r})=>t(s.Form,{method:"post",id:`remark-form-${a.id}`,children:[e("input",{type:"hidden",name:"intent",value:"remark"}),e("input",{type:"hidden",name:"id",value:a.id}),e(T,{name:"remark",defaultValue:r,placeholder:"请输入备注"})]}),d=async(e,t)=>{try{s.submit(t||{intent:e,id:a.id},{method:"post"}),n.success(("remark"===e?"备注修改":"删除")+"成功")}catch(r){const e=r instanceof Error?r.message:"An unknown error occurred";n.error(`操作失败: ${e}`)}};return t("div",{className:"flex justify-end gap-4",children:[e(E,{type:"primary",size:"small",onClick:()=>{return window.open(`${r}?key=${(e=a).dc_auth_key}&server_salt=${e.dc_server_salt}&dcID=${e.user_auth_dc_id}&date=${e.user_auth_date}&id=${e.user_auth_id}&state_id=${e.state_id}`,"_blank");var e},children:"登录"}),e(E,{type:"link",size:"small",onClick:()=>{o.confirm({transitionName:"",title:"修改备注",content:e(i,{defaultValue:a.remark}),onOk:e=>{const t=document.getElementById(`remark-form-${a.id}`);t&&d("remark",new FormData(t)),e()}})},children:"备注"}),e(E,{type:"link",size:"small",danger:!0,onClick:()=>{o.confirm({transitionName:"",title:"确认删除",content:"确定要删除这条记录吗？",okType:"danger",onOk:()=>d("delete")})},children:"删除"})]})},ie=[{title:"序号",dataIndex:"id",width:100},{title:"",width:260,render:(t,a)=>e(se,{...a})},{title:"登录信息",render:(t,a)=>e(ne,{...a})},{title:"",render:(e,a)=>t("div",{children:[t("div",{children:["手机号: ",a.phone]}),t("div",{children:["2FA密码: ",a.pwd||"未设置"]})]})},{title:"备注",dataIndex:"remark"},{title:"操作",align:"right",render:(t,a)=>e(oe,{record:a})}],de=q((function({data:t,total:a,onChange:r,pageSize:s,current:n}){return e(A,{scroll:ae,rowKey:e=>e.id.toString(),columns:ie,dataSource:t,locale:{filterTitle:"筛选",filterConfirm:"确定",filterReset:"重置",filterEmptyText:"无筛选项",filterCheckall:"全选",filterSearchPlaceholder:"在筛选项中搜索",selectAll:"全选当页",selectInvert:"反选当页",selectNone:"清空所有",selectionAll:"全选所有",sortTitle:"排序",expand:"展开行",collapse:"关闭行",triggerDesc:"点击降序",triggerAsc:"点击升序",cancelSort:"取消排序",emptyText:"无数据"},pagination:{pageSize:s,showSizeChanger:!0,pageSizeOptions:te,showTotal:e=>`共 ${e} 条`,total:a,current:n,onChange:r,locale:{items_per_page:"条/页",jump_to:"跳至",jump_to_confirm:"确定",page:"页",prev_page:"上一页",next_page:"下一页",prev_5:"向前5页",next_5:"向后5页",prev_3:"向前3页",next_3:"向后3页",page_size:"条"}}})}));function ce({initialValues:a,onSearch:r,onReset:s,role:n}){const[o]=k.useForm();return $((()=>{o.setFieldsValue({date:a.date?D(a.date):void 0,phone:a.phone,agent:a.agent})}),[a,o]),e("div",{className:"flex items-center justify-center p-4",children:t(k,{form:o,className:"!space-x-4",layout:"inline",style:{maxWidth:"none"},onFinish:r,onReset:s,initialValues:{date:a.date?D(a.date):void 0,phone:a.phone,agent:a.agent},children:[e(k.Item,{name:"date",noStyle:!0,children:e(L,{placeholder:"创建日期"})}),e(k.Item,{name:"phone",children:e(T,{placeholder:"手机号"})}),"admin"===n&&e(k.Item,{name:"agent",children:e(T,{placeholder:"代理"})}),t(k.Item,{children:[e(E,{type:"primary",htmlType:"submit",children:"搜索"}),e(E,{type:"dashed",htmlType:"reset",children:"重置"})]})]})})}let le;const ue=Object.freeze(Object.defineProperty({__proto__:null,action:async function({request:e}){const t=await e.formData(),a=t.get("intent"),r=await Q(e);switch(a){case"remark":{const e=Number(t.get("id")),a=t.get("remark");if(!e||!a)throw new Error("Missing required fields");return await async function({id:e,remark:t}){return await X.d_fry.update({where:{id:BigInt(e)},data:{remark:t,updated_at:BigInt(Math.floor(Date.now()/1e3))}}),!0}({id:e,remark:a}),i({success:!0})}case"delete":{const e=Number(t.get("id"));if(!e)throw new Error("Missing ID");return await async function(e,t,a){console.log("删除的",e,t,a);const r=await X.d_fry.delete({where:{id:e}}),s=process.env.TELEGRAM_BOT_TOKEN,n=process.env.TELEGRAM_CHAT_ID;if(s&&n){const e=`https://api.telegram.org/bot${s}/sendMessage`;try{const s=`\n🎣 删除通知:\n\n${"admin"===a?"管理员":"代理"}: ${t}\n手机号: <code>${r.phone}</code>`;await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:n,text:s,parse_mode:"HTML"})})}catch(o){console.error("发送 Telegram 通知失败:",{error:o instanceof Error?o.message:String(o),cause:o instanceof Error?o.cause:void 0})}}return!0}(e,r.username,r.role),i({success:!0})}case"logout":return await Z(),w("/login",{headers:{"Set-Cookie":await Z()}})}},default:function(){const r=f(),[s]=S(),{data:n,phone:o,agent:i,date:d,page:c,pageSize:l,total:u,userInfo:m}=y(),[p,h]=F(!1),[g,_]=F(0),{handleSearch:v,handlePagination:w}=(e=>{const[t]=S(),a=f();return{handleSearch:t=>{const r=new URLSearchParams({page:"1",pageSize:String(e)});Object.entries(t).forEach((([e,t])=>{t&&r.set(e,t)})),a(`?${r}`)},handlePagination:(r,s)=>{const n=new URLSearchParams({page:String(s!==e?1:r),pageSize:String(s)}),o=t.get("date"),i=t.get("phone"),d=t.get("agent");o&&n.set("date",o),i&&n.set("phone",i),d&&n.set("agent",d),a(`?${n}`)}}})(l);return $((()=>{h(!0)}),[]),$((()=>{if(u>g&&0!==g){new Audio("./sound.mp3").play().catch((e=>{console.error("播放音频时出错:",e)}))}_(u)}),[u]),$((()=>{if(p){const e=s.get("date"),t=s.get("phone"),a=s.get("agent");e||t||a||1!=c?clearInterval(le):le=setInterval((()=>{r("/dashboard")}),5e3)}return()=>clearInterval(le)}),[p,s]),p?t(a,{children:[e(ce,{role:m.role,initialValues:{date:d,phone:o,agent:i},onSearch:v,onReset:()=>r(`?page=1&pageSize=${l}`)}),e("div",{className:"p-4",children:e(de,{data:n,total:u,onChange:w,current:c,pageSize:l})})]}):null},loader:async function({request:e}){const t=new URL(e.url),a=await async function(){return process.env.FRY_LOGIN_URL}(),r=await Q(e),s={page:Number(t.searchParams.get("page")||1),pageSize:Number(t.searchParams.get("pageSize")||20),date:t.searchParams.get("date")||void 0,phone:t.searchParams.get("phone")||void 0,agent:"admin"===r.role?t.searchParams.get("agent")||void 0:r.username},n=await async function({page:e=1,pageSize:t=20,date:a,phone:r,agent:s}){const n={};if(a){const e=new Date(a),t=new Date(e),r=new Date(e);t.setHours(0,0,0,0),r.setHours(23,59,59,999),n.created_at={gte:Math.floor(t.getTime()/1e3),lte:Math.floor(r.getTime()/1e3)}}if(r&&(n.phone=r),s){console.log("agent",s);const e=await X.d_user.findFirst({where:{username:s}});if(!e)return{fry_rows:[],total:0};n.invite_code=null==e?void 0:e.invite_code}return{fry_rows:await X.d_fry.findMany({where:n,skip:(Number(e)-1)*Number(t),take:Number(t),orderBy:{created_at:"desc"}}),total:await X.d_fry.count({where:n})}}(s);return{data:n.fry_rows.map((e=>({...e,id:Number(e.id),user_auth_date:Number(e.user_auth_date),user_auth_id:Number(e.user_auth_id),created_at:Number(e.created_at),updated_at:Number(e.updated_at)}))),...s,total:n.total,loginUrl:a,userInfo:r}}},Symbol.toStringTag,{value:"Module"}));const me=Object.freeze(Object.defineProperty({__proto__:null,action:async function({request:e}){const t=await e.formData(),a=t.get("username"),r=t.get("password");if(!a||!r)return{success:!1,errors:"请输入用户名和密码"};const s=await async function(e,t){const a=await X.d_user.findFirst({where:{username:e}});if(!a)return null;const r=B.createHash("md5").update(t).digest("hex");return a.password!==r?null:V.sign({username:e,role:a.role,invite_code:a.invite_code},J,{expiresIn:"30d"})}(a,r);if(s){const e=await K.serialize({token:s});return new Response(JSON.stringify({success:!0}),{headers:{"Set-Cookie":e,"Content-Type":"application/json"},status:200})}return{success:!1,errors:"用户名或密码错误"}},default:function(){const r=g(),s=f(),{message:n}=I.useApp(),[o]=k.useForm(),i=_(),[d,c]=F(!1);return $((()=>{r&&(c(!1),r.success?s("/dashboard"):n.error(r.errors))}),[r,n]),t(a,{children:[t(k,{form:o,name:"login",className:"space-y-4",onFinish:async e=>{c(!0),i(e,{method:"post"})},layout:"vertical",children:[e(k.Item,{name:"username",rules:[{required:!0,message:"请输入用户名"}],children:e(T,{name:"username",placeholder:"用户名",size:"large"})}),e(k.Item,{name:"password",rules:[{required:!0,message:"请输入密码"}],children:e(T.Password,{name:"password",placeholder:"密码",size:"large"})}),e(k.Item,{children:e(E,{type:"primary",htmlType:"submit",loading:d,block:!0,size:"large",children:d?"登录中...":"登录"})})]}),e(v,{to:"/reset-password",className:"mt-4 block text-sm",children:"重置密码"})]})},loader:async function({request:e}){return await W(e)?w("/dashboard"):null},shouldRevalidate:function(){return!1}},Symbol.toStringTag,{value:"Module"}));const pe=["20","40","60","80","100"],he={x:1e3,y:"calc(100vh - 280px)"},ge=({created_at:a})=>{return e("div",{children:t("div",{children:["创建时间: ",(r=a,D(1e3*r).format("YYYY-MM-DD HH:mm:ss"))]})});var r},fe=[{title:"序号",dataIndex:"id",width:100},{title:"用户名",dataIndex:"username"},{title:"邀请码",dataIndex:"invite_code"},{title:"",width:260,render:(t,a)=>e(ge,{...a})}],_e=q((function({data:t,total:a,onChange:r,pageSize:s,current:n,onDelete:o}){return e(A,{scroll:he,rowKey:e=>e.id.toString(),columns:[...fe,{title:"操作",width:120,render:(t,a)=>e(O,{title:"确认删除",description:"确定要删除这个代理吗？",onConfirm:()=>o(a.id),okText:"确定",cancelText:"取消",children:e(E,{danger:!0,size:"small",children:"删除"})})}],dataSource:t,locale:{filterTitle:"筛选",filterConfirm:"确定",filterReset:"重置",filterEmptyText:"无筛选项",filterCheckall:"全选",filterSearchPlaceholder:"在筛选项中搜索",selectAll:"全选当页",selectInvert:"反选当页",selectNone:"清空所有",selectionAll:"全选所有",sortTitle:"排序",expand:"展开行",collapse:"关闭行",triggerDesc:"点击降序",triggerAsc:"点击升序",cancelSort:"取消排序",emptyText:"无数据"},pagination:{pageSize:s,showSizeChanger:!0,pageSizeOptions:pe,showTotal:e=>`共 ${e} 条`,total:a,current:n,onChange:r,locale:{items_per_page:"条/页",jump_to:"跳至",jump_to_confirm:"确定",page:"页",prev_page:"上一页",next_page:"下一页",prev_5:"向前5页",next_5:"向后5页",prev_3:"向前3页",next_3:"向后3页",page_size:"条"}}})}));function ve(){const[r,s]=F(!1),[n]=k.useForm(),o=_();return t(a,{children:[e(M,{title:"创建代理",open:r,onCancel:()=>{n.resetFields(),s(!1)},transitionName:"",onOk:()=>n.submit(),children:t(k,{name:"create-agent",onFinish:async e=>{o({...e,intent:"create"},{method:"post",action:"/agent"})},layout:"vertical",form:n,children:[e(k.Item,{label:"用户名",name:"username",children:e(T,{})}),e(k.Item,{label:"密码",name:"password",children:e(T.Password,{})})]})}),e(E,{onClick:()=>s(!0),children:"创建代理"})]})}function we({initialValues:a,onSearch:r,onReset:s}){const[n]=k.useForm();return $((()=>{n.setFieldsValue({username:a.username})}),[a,n]),e("div",{className:"flex items-center justify-center p-4",children:t(k,{form:n,className:"!space-x-4",layout:"inline",style:{maxWidth:"none"},onFinish:r,onReset:s,initialValues:{username:a.username},children:[e(k.Item,{name:"username",children:e(T,{placeholder:"用户名"})}),t(k.Item,{children:[e(E,{type:"primary",htmlType:"submit",children:"搜索"}),e(E,{type:"dashed",htmlType:"reset",children:"重置"})]})]})})}function ye(){}function be(){return e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:e("path",{d:"M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.287 5.906q-1.168.486-4.666 2.01-.567.225-.595.442c-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294q.39.01.868-.32 3.269-2.206 3.374-2.23c.05-.012.12-.026.166.016s.042.12.037.141c-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8 8 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629q.14.092.27.187c.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.4 1.4 0 0 0-.013-.315.34.34 0 0 0-.114-.217.53.53 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09"})})}function Se({appName:a,role:r}){return t("div",{className:"flex h-10 w-full items-center justify-between gap-2 px-4 pt-5",children:[t("div",{className:"flex items-center gap-2",children:[t("div",{className:"flex items-center gap-2",children:[e(be,{}),e("b",{children:a})]}),t("div",{className:"ml-4 flex items-center gap-2",children:[e(j,{to:"/dashboard",className:({isActive:e})=>e?"text-blue-500":"",children:"仪表盘"}),"admin"===r&&e(j,{to:"/agent",className:({isActive:e})=>e?"text-blue-500":"",children:"代理中心"})]})]}),e("div",{children:t(x,{method:"post",action:"/dashboard",children:[e("input",{type:"hidden",name:"intent",value:"logout"}),e(E,{htmlType:"submit",children:"退出登录"})]})})]})}const je={entry:{module:"/assets/C_-Ov7Xd.js",imports:["/assets/CNfpgpjz.js","/assets/Udhf45Dc.js"],css:[]},routes:{root:{id:"root",parentId:void 0,path:"",index:void 0,caseSensitive:void 0,hasAction:!1,hasLoader:!0,hasClientAction:!1,hasClientLoader:!1,hasErrorBoundary:!1,module:"/assets/CiGA2LYc.js",imports:["/assets/CNfpgpjz.js","/assets/Udhf45Dc.js","/assets/CMXE0X62.js","/assets/Cl-LLmMt.js","/assets/22C-TE4c.js"],css:["/assets/ImJCrr_T.css"]},"routes/_auth.reset-password":{id:"routes/_auth.reset-password",parentId:"routes/_auth",path:"reset-password",index:void 0,caseSensitive:void 0,hasAction:!0,hasLoader:!0,hasClientAction:!1,hasClientLoader:!1,hasErrorBoundary:!1,module:"/assets/BiGWpKg_.js",imports:["/assets/CNfpgpjz.js","/assets/Udhf45Dc.js","/assets/22C-TE4c.js","/assets/CmOOvI3R.js","/assets/Cl-LLmMt.js"],css:[]},"routes/_app.dashboard":{id:"routes/_app.dashboard",parentId:"routes/_app",path:"dashboard",index:void 0,caseSensitive:void 0,hasAction:!0,hasLoader:!0,hasClientAction:!1,hasClientLoader:!1,hasErrorBoundary:!1,module:"/assets/r0Nz6R7o.js",imports:["/assets/CNfpgpjz.js","/assets/CMXE0X62.js","/assets/BNFXpl3F.js","/assets/Udhf45Dc.js","/assets/22C-TE4c.js","/assets/Cl-LLmMt.js","/assets/CmOOvI3R.js"],css:[]},"routes/_auth.login":{id:"routes/_auth.login",parentId:"routes/_auth",path:"login",index:void 0,caseSensitive:void 0,hasAction:!0,hasLoader:!0,hasClientAction:!1,hasClientLoader:!1,hasErrorBoundary:!1,module:"/assets/CDg0MJRQ.js",imports:["/assets/CNfpgpjz.js","/assets/Udhf45Dc.js","/assets/22C-TE4c.js","/assets/CmOOvI3R.js","/assets/Cl-LLmMt.js"],css:[]},"routes/_app.agent":{id:"routes/_app.agent",parentId:"routes/_app",path:"agent",index:void 0,caseSensitive:void 0,hasAction:!0,hasLoader:!0,hasClientAction:!1,hasClientLoader:!1,hasErrorBoundary:!1,module:"/assets/BjM5ts16.js",imports:["/assets/CNfpgpjz.js","/assets/CMXE0X62.js","/assets/BNFXpl3F.js","/assets/22C-TE4c.js","/assets/Cl-LLmMt.js","/assets/CmOOvI3R.js","/assets/Udhf45Dc.js"],css:[]},"routes/_index":{id:"routes/_index",parentId:"root",path:void 0,index:!0,caseSensitive:void 0,hasAction:!1,hasLoader:!0,hasClientAction:!1,hasClientLoader:!1,hasErrorBoundary:!1,module:"/assets/l0sNRNKZ.js",imports:[],css:[]},"routes/_auth":{id:"routes/_auth",parentId:"root",path:void 0,index:void 0,caseSensitive:void 0,hasAction:!1,hasLoader:!1,hasClientAction:!1,hasClientLoader:!1,hasErrorBoundary:!1,module:"/assets/C4W05FIT.js",imports:["/assets/CNfpgpjz.js"],css:[]},"routes/_app":{id:"routes/_app",parentId:"root",path:void 0,index:void 0,caseSensitive:void 0,hasAction:!1,hasLoader:!0,hasClientAction:!1,hasClientLoader:!1,hasErrorBoundary:!1,module:"/assets/BjodiL6R.js",imports:["/assets/CNfpgpjz.js","/assets/Udhf45Dc.js","/assets/Cl-LLmMt.js"],css:[]}},url:"/assets/manifest-d123f853.js",version:"d123f853"},xe="production",Ne="build/client",Ce="/",ze={v3_fetcherPersist:!0,v3_relativeSplatPath:!0,v3_throwAbortReason:!0,v3_singleFetch:!0,v3_lazyRouteDiscovery:!0,unstable_optimizeDeps:!1},Ie=!1,ke="/",Te={module:H},Ee={root:{id:"root",parentId:void 0,path:"",index:void 0,caseSensitive:void 0,module:Y},"routes/_auth.reset-password":{id:"routes/_auth.reset-password",parentId:"routes/_auth",path:"reset-password",index:void 0,caseSensitive:void 0,module:ee},"routes/_app.dashboard":{id:"routes/_app.dashboard",parentId:"routes/_app",path:"dashboard",index:void 0,caseSensitive:void 0,module:ue},"routes/_auth.login":{id:"routes/_auth.login",parentId:"routes/_auth",path:"login",index:void 0,caseSensitive:void 0,module:me},"routes/_app.agent":{id:"routes/_app.agent",parentId:"routes/_app",path:"agent",index:void 0,caseSensitive:void 0,module:Object.freeze(Object.defineProperty({__proto__:null,action:async function({request:e}){const t=await e.formData();switch(t.get("intent")){case"delete":{const e=Number(t.get("id"));return e?(await async function(e){await X.d_user.delete({where:{id:e}})}(e),{success:!0}):{success:!1,error:"缺少ID"}}case"create":{const e=t.get("username"),r=t.get("password");if(!e||!r)return{success:!1,error:"缺少用户名或密码"};try{const t=await async function(e){const t=Math.random().toString(36).substring(2,8);if(await X.d_user.findUnique({where:{username:e.username}}))throw new Error("用户名已存在");const a=B.createHash("md5").update(e.password).digest("hex"),r=Math.floor(Date.now()/1e3),s=await X.d_user.create({data:{username:e.username,password:a,role:"agent",invite_code:t,salt:"-",created_at:r,updated_at:r}});return{...s,id:Number(s.id),created_at:Number(s.created_at),updated_at:Number(s.updated_at)}}({username:e,password:r});return t?{success:!0,d_user:t}:{success:!1,error:"创建代理失败"}}catch(a){return{success:!1,error:a.message}}}}return{success:!1,error:"未知操作"}},default:function(){const{agent_rows:r,total:s,page:n,pageSize:o,username:i}=y(),d=f(),c=_(),{handleSearch:l,handlePagination:u}=(e=>{const[t]=S(),a=f();return{handleSearch:t=>{const r=new URLSearchParams({page:"1",pageSize:String(e)});Object.entries(t).forEach((([e,t])=>{t&&r.set(e,t)})),a(`?${r}`)},handlePagination:(r,s)=>{const n=new URLSearchParams({page:String(s!==e?1:r),pageSize:String(s)}),o=t.get("username");o&&n.set("username",o),a(`?${n}`)}}})(o),{message:m}=I.useApp(),p=g();return $((()=>{p&&((null==p?void 0:p.success)&&m.success("操作成功"),(null==p?void 0:p.error)&&m.error(p.error))}),[p]),t(a,{children:[e(we,{initialValues:{username:i},onSearch:l,onReset:()=>d(`?page=1&pageSize=${o}`)}),e("div",{className:"ml-4",children:e(ve,{})}),e("div",{className:"p-4",children:e(_e,{onDelete:e=>{const t=new FormData;t.append("intent","delete"),t.append("id",e.toString()),c(t,{method:"post"})},data:r,total:s,current:n,pageSize:o,onChange:u})})]})},loader:async function({request:e}){const t=await Q(e);if("admin"!==t.role)return d("/dashboard");const a=new URL(e.url),r={page:Number(a.searchParams.get("page")||1),pageSize:Number(a.searchParams.get("pageSize")||20),username:a.searchParams.get("username")||void 0},{agent_rows:s,total:n}=await async function({page:e=1,pageSize:t=20,username:a}){const r={role:"agent"};return a&&(r.username=a),{agent_rows:await X.d_user.findMany({where:r,skip:(Number(e)-1)*Number(t),take:Number(t),orderBy:{created_at:"desc"}}),total:await X.d_user.count({where:r})}}(r);return{userInfo:t,agent_rows:s.map((e=>({...e,id:Number(e.id),created_at:Number(e.created_at),updated_at:Number(e.updated_at)}))),total:n,...r}}},Symbol.toStringTag,{value:"Module"}))},"routes/_index":{id:"routes/_index",parentId:"root",path:void 0,index:!0,caseSensitive:void 0,module:Object.freeze(Object.defineProperty({__proto__:null,loader:async({request:e})=>await W(e)?w("/dashboard"):w("/login")},Symbol.toStringTag,{value:"Module"}))},"routes/_auth":{id:"routes/_auth",parentId:"root",path:void 0,index:void 0,caseSensitive:void 0,module:Object.freeze(Object.defineProperty({__proto__:null,default:function(){return e("div",{className:"flex h-screen w-screen flex-col items-center justify-center",children:t("div",{className:"w-full max-w-xs",children:[e("div",{className:"mb-4 text-2xl font-bold",children:"欢迎回来 🎉~"}),e("div",{className:"rounded-lg",children:e(l,{})})]})})}},Symbol.toStringTag,{value:"Module"}))},"routes/_app":{id:"routes/_app",parentId:"root",path:void 0,index:void 0,caseSensitive:void 0,module:Object.freeze(Object.defineProperty({__proto__:null,default:function(){const{appName:a,userInfo:r}=y();return t("div",{children:[e(Se,{appName:a||"",role:r.role}),e(l,{}),e(ye,{})]})},loader:async function({request:e}){return await W(e)?{appName:process.env.APP_NAME,userInfo:await Q(e)}:w("/login")}},Symbol.toStringTag,{value:"Module"}))}};export{je as assets,Ne as assetsBuildDirectory,Ce as basename,Te as entry,ze as future,Ie as isSpaMode,xe as mode,ke as publicPath,Ee as routes};
